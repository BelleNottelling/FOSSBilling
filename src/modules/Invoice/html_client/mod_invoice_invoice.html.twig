{% extends request.ajax ? "layout_blank.html.twig" : "layout_default.html.twig" %}

    {% import "macro_functions.html.twig" as mf %}
    
    {% set nr = invoice.serie ~ "%05s"|format(invoice.nr) %}
    
    {% block meta_title %}{{ 'Proforma invoice'|trans }}{% endblock %}
    
    {% block body_class %}invoice-invoice{% endblock %}
    
    {% block breadcrumb %}
        <li class="breadcrumb-item"><a href="{{ '/invoice'|link }}">{{ 'Invoices'|trans }}</a></li>
        <li class="breadcrumb-item active" aria-current="page">
            {% if invoice.status == 'paid' %}
                {{ 'Receipt'|trans }}
            {% else %}
                {{ 'Invoice'|trans }}
            {% endif %}
            {{ nr }}
        </li>
    {% endblock %}
    
    {% block content %}
    {% set seller = invoice.seller %}
    {% set buyer = invoice.buyer %}
    {% set company = guest.system_company %}
    
    <div class="row">
        {% if invoice.status == 'unpaid' %}
            <div class="ml-3 alert alert-danger w-100" role="alert">
                <h3>{{ 'Payment methods'|trans }}</h3>
                <p>{{ 'Please choose a payment type and pay for your chosen products.'|trans }}</p>
    
                <form method="post" action="{{ 'api/guest/invoice/payment'|link }}" class="api-form" data-api-redirect="{{ ('invoice/'~invoice.hash)|link({ 'auto_redirect': 1 }) }}">
                    <input type="hidden" name="CSRFToken" value="{{ CSRFToken }}"/>
                    <input type="hidden" name="hash" value="{{ invoice.hash }}"/>
                    {% for gtw in guest.invoice_gateways %}
                        {% if invoice.currency in gtw.accepted_currencies %}
                            {% set banklink = 'invoice/banklink'|link %}
                            <button type="button" style="cursor: pointer; background: transparent url('{{gtw.logo.logo}}') no-repeat scroll 0% 0%; height:{{gtw.logo.height}}; width:{{gtw.logo.width}}; background-size: contain; border: 0; margin: 10px;" type="radio" name="gateway_id" gateway_id="{{ gtw.id }}" data-toggle="tooltip" title="{{ 'Pay with'|trans }} {{gtw.title}}" onclick="window.location.replace('{{banklink}}/{{invoice.hash}}/{{gtw.id}}')")></button>
                        {% endif %}
                    {% endfor %}
                    <input type="hidden" name="gateway_id" id="gateway_id">
                </form>
            </div>
        {% endif %}
    
        <div class="card ml-3 w-100">
            <div class="card-header">
                <h2>
                    {% if invoice.status == 'paid' %}
                        {{ 'Receipt'|trans }}
                    {% else %}
                        {{ 'Invoice'|trans }}
                    {% endif %}
                    - {{ nr }}
                </h2>
    
                <span>{{ 'You can print this invoice or export it to a PDF file by clicking on the corresponding button.'|trans }}</span>
    
                <div class="row mt-3">
                    <a href="{{ 'invoice/pdf'|link }}/{{ invoice.hash }}" target="_blank" class="ml-3 btn btn-info">{{ 'PDF'|trans }}</a>
                    <a href="{{ 'invoice/print'|link }}/{{ invoice.hash }}" target="_blank" class="ml-2 btn btn-info">{{ 'Print'|trans }}</a>
                </div>
            </div>
    
            <div class="card-body">
                <div class="container">
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <div class="well small">
                                <h5>{{ 'Invoice'|trans }}</h5>
                                <dl class="row">
                                    <dt class="col-sm-4">{{ 'Invoice'|trans }}:</dt>
                                    <dd class="col-sm-8">{{ nr }}</dd>
                                    <dt class="col-sm-4">{{ 'Invoice Date'|trans }}:</dt>
                                    <dd class="col-sm-8">
                                        {% if invoice.paid_at %}
                                            {{ invoice.paid_at|format_date }}
                                        {% else %}
                                            {{ invoice.created_at|format_date }}
                                        {% endif %}
                                    </dd>
                                    <dt class="col-sm-4">{{ 'Due Date'|trans }}:</dt>
                                    <dd class="col-sm-8">
                                        {% if invoice.due_at %}
                                            {{ invoice.due_at|format_date }}
                                        {% else %}
                                            -----
                                        {% endif %}
                                    </dd>
                                    <dt class="col-sm-4">{{ 'Status'|trans }}:</dt>
                                    <dd class="col-sm-8">
                                        <span class="badge {% if invoice.status == 'paid' %} badge-success{% elseif invoice.status == 'unpaid' %}badge-warning{% endif %}">
                                            {{ invoice.status|capitalize }}
                                        </span>
                                    </dd>
                                </dl>
                            </div>
                        </div>
                
                        <div class="col-md-6 mb-4">
                            <div class="well small">
                                <h5>{{ 'Company'|trans }}</h5>
                                <dl class="row">
                                    {% if seller.company %}
                                        <dt class="col-sm-4">{{ 'Name'|trans }}:</dt>
                                        <dd class="col-sm-8">{{ seller.company }}</dd>
                                    {% endif %}
                
                                    {% if seller.company_vat%}
                                        <dt class="col-sm-4">{{ 'VAT'|trans }}:</dt>
                                        <dd class="col-sm-8">{{ seller.company_vat }}</dd>
                                    {% endif %}
                
                                    {% if seller.address%}
                                        <dt class="col-sm-4">{{ 'Address'|trans }}:</dt>
                                        <dd class="col-sm-8">{{ seller.address }}</dd>
                                    {% endif %}
                
                                    {% if seller.phone %}
                                        <dt class="col-sm-4">{{ 'Phone'|trans }}:</dt>
                                        <dd class="col-sm-8">{{ seller.phone }}</dd>
                                    {% endif %}
                
                                    {% if seller.email %}
                                        <dt class="col-sm-4">{{ 'Email'|trans }}:</dt>
                                        <dd class="col-sm-8">{{ seller.email }}</dd>
                                    {% endif %}
                
                                    {% if seller.account_number %}
                                        <dt class="col-sm-4">{{ 'Account'|trans }}:</dt>
                                        <dd class="col-sm-8">{{ seller.account_number }}</dd>
                                    {% endif %}
                
                                    {% if seller.note %}
                                        <dt class="col-sm-4">{{ 'Note'|trans }}:</dt>
                                        <dd class="col-sm-8">{{ seller.note }}</dd>
                                    {% endif %}
                                </dl>
                            </div>
                        </div>
                    </div>
                
                    <div class="row">
                        <div class="col-md-6">
                            <div class="well small">
                                <h5>{{ 'Client'|trans }}</h5>
                                <dl class="row">
                                    {% if buyer.first_name or buyer.last_name %}
                                        <dt class="col-sm-4">{{ 'Name'|trans }}:</dt>
                                        <dd class="col-sm-8">{{ buyer.first_name }} {{ buyer.last_name }}</dd>
                                    {% endif %}
                
                                    {% if buyer.company %}
                                        <dt class="col-sm-4">{{ 'Company'|trans }}:</dt>
                                        <dd class="col-sm-8">{{ buyer.company }}</dd>
                                    {% endif %}
                
                                    {% if buyer.company_number %}
                                        <dt class="col-sm-4">{{ 'Company number'|trans }}:</dt>
                                        <dd class="col-sm-8">{{ buyer.company_number }}</dd>
                                    {% endif %}
                
                                    {% if buyer.company_vat %}
                                        <dt class="col-sm-4">{{ 'Company VAT'|trans }}:</dt>
                                        <dd class="col-sm-8">{{ buyer.company_vat }}</dd>
                                    {% endif %}
                
                                    {% if buyer.address %}
                                        <dt class="col-sm-4">{{ 'Address'|trans }}:</dt>
                                        <dd class="col-sm-8">{{ buyer.address }}</dd>
                                        <dd class="col-sm-8">{{ buyer.city }}, {{ buyer.state }}</dd>
                                        <dd class="col-sm-8">{{ buyer.zip }}, {{ guest.system_countries[buyer.country] }}</dd>
                                    {% endif %}
                
                                    {% if buyer.phone %}
                                        <dt class="col-sm-4">{{ 'Phone'|trans }}:</dt>
                                        <dd class="col-sm-8">{{ buyer.phone }}</dd>
                                    {% endif %}
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>                
    
                {% if invoice.text_1 %}
                    <div class="well mt-3">
                        {{ invoice.text_1|markdown }}
                    </div>
                {% endif %}
    
                <table class="table table-striped table-bordered table-hover mt-3">
                    <thead>
                        <tr>
                            <th>{{ '#'|trans }}</th>
                            <th>{{ 'Title'|trans }}</th>
                            <th>{{ 'Price'|trans }}</th>
                            <th>{{ 'Total'|trans }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for i, item in invoice.lines %}
                            <tr>
                                <td>{{ i+1 }}.</td>
                                <td>
                                    {% if item.order_id %}
                                        <a href="{{ '/order/service'|link }}/manage/{{ item.order_id }}">{{ item.title }}</a>
                                    {% else %}
                                        {{ item.title }}
                                    {% endif %}
                                    {% if item.quantity > 1 %}
                                        x {{ item.quantity }} {{ item.unit }}
                                    {% endif %}
                                </td>
                                <td>{{ item.price|money(invoice.currency) }}</td>
                                <td>{{ item.total|money(invoice.currency) }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
    
                <div class="row">
                    <div class="col-md-4 offset-md-8">
                        <table class="table table-bordered">
                            {% if invoice.tax > 0 %}
                                <tr>
                                    <td>{{ invoice.taxname }} {{ invoice.taxrate }}%</td>
                                    <td>{{ invoice.tax | money(invoice.currency) }}</td>
                                </tr>
                            {% endif %}
                            {% if invoice.discount > 0 %}
                                <tr>
                                    <td>{{ 'Discount'|trans }}</td>
                                    <td>{{ invoice.discount | money(invoice.currency) }}</td>
                                </tr>
                            {% endif %}
                            <tr>
                                <td><strong>{{ 'Total'|trans }}</strong></td>
                                <td><strong>{{ invoice.total | money(invoice.currency) }}</strong></td>
                            </tr>
                        </table>
                    </div>
                </div>
    
                {% if invoice.text_2 %}
                    <div class="well mt-3">
                        {{ invoice.text_2|markdown }}
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endblock %}
    